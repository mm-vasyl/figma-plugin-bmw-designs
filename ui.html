<style>
* {
  box-sizing: border-box;
}
:root {
  --black: rgb(10, 10, 10);
  --white: rgb(255, 255, 255);
}
body {
  margin: 0;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}
.window {
  font-family: Helvetica, Arial, sans-serif;
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: rgb(55, 55, 55);
  width: 100%;
  height: 100%;
}
.content {
  width: 480px;
}
label {
  display: block;
  width: 100%;
  font-size: 14px;
}
#err {
  opacity: 0;
  overflow: hidden;
  color: rgb(255, 40, 40);
  transition: opacity 0.4s;
  width: 100%;
  padding: 5px 0;
  pointer-events: none;
}
#import, #cancel, #update {
  box-sizing: border-box;
  border-radius: 8px;
  color: var(--black);
  background-color: var(--white);
  padding: 8px 16px;
  font-size: 20px;
  cursor: pointer;
  display: inline-block;
  border: none;
  transition: color .2s, background-color .2s, border .2s;
  border: 2px solid var(--black);
}
#update {
  background-color: var(--black);
  color: var(--white);
  border: 2px solid var(--white);
}
#update:hover {
  color: var(--black);
  background-color: var(--white);
  border: 2px solid var(--black);
}
#import:hover, #cancel:hover {
  background-color: var(--black);
  color: var(--white);
  border: 2px solid var(--white);
}
#import, #update {
  width: 100%;
}
.btns {
  display: flex;
  justify-content: space-around;
  gap: 10px;
}
label {
  border: 2px solid var(--white);
  color: var(--white);
  background-color: var(--black);
  padding: 10px 20px 0 20px;
  width: 100%;
  border-radius: 8px;
  cursor: pointer;
  overflow: hidden;
  transition: color .2s, background-color .2s, border .2s;
}
.split {
  margin-top: 10px;
  display: flex;
  gap: 10px;
  width: 100%;
}
.split label {
  width: 50%;
}
#json {
  width: 100%;
  padding: 5px 10px;
  border-radius: 8px;
  border: 2px solid var(--white);
  color: var(--white);
  background-color: var(--black);
  margin: 10px 0;
  transition: outline .2s;
  cursor: text !important;
}
#images, #jsonFile {
  padding: 5px 0 10px 0;
  cursor: pointer;
}
#images::file-selector-button, #jsonFile::file-selector-button {
  transition: color .2s, background-color .2s, border .2s;
  padding: 5px 10px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  border: 2px solid var(--black);
  font-weight: bold;
}
#images::file-selector-button:hover, #jsonFile::file-selector-button:hover {
  background-color: var(--black);
  color: var(--white);
  border: 2px solid var(--white);
}
.imagesWrapper {
  display: flex;
  gap: 10px;
  align-items: center;
}
.clearCache {
  background-color: var(--white);
  color: var(--black);
  border: 2px solid var(--black);
  font-size: 24px;
  border-radius: 8px;
  cursor: pointer;
  padding: 0;
  padding: 5px;
}
.clearCache svg {
  width: 30px;
  height: 30px;
}
.clearCache:hover {
  background-color: var(--black);
  color: var(--white);
  border: 2px solid var(--white);
}
.clearCache:hover svg {
  fill: var(--white);
}
</style>

<div class="window">
  <div class="content">
    <div class="imagesWrapper">
      <label>
        Upload all images:
        <input type="file" id="images" multiple accept=".jpg, .png, .jpeg">
      </label>
      <button class="clearCache" title="clear image cache">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="200 200 600 600" enable-background="new 200 200 600 600" xml:space="preserve">
          <g><path d="M601.8,756.8c-1.5,0-3.1-0.1-4.7-0.2c-39-3.7-77.7-12.7-115-26.7c-70.1-26.4-128-67-172.2-120.8c-8.2-10-9.9-21.6-4.9-32.6c4.9-10.7,14.9-16.9,27.4-17.1c31.7-0.4,63.9-6.7,95.6-18.7c31.5-11.9,54.1-26.8,71.2-46.9c3.6-4.3,6.9-9.2,10.4-14.3c1.7-2.5,3.4-5.1,5.2-7.6l5.5-7.8l51.5,29l-6.6,9.5c-1.9,2.8-3.7,5.5-5.6,8.2c-4,6-8.2,12.3-12.8,18.1c-15.3,19.3-35.1,35.6-60.6,49.8c-26.9,15-57,25.8-91.3,32.9c9,7.2,17.4,13.7,25.5,19.7c18.8-4.3,33.9-11.8,45.9-22.9l23.6-21.8l-6,31.6c-1.8,9.3-13.8,25.2-23.6,37c6.6,3.1,13.3,6.4,19.7,10.2c8.4,4.9,16.2,4.8,28.5-0.6c21.5-9.3,39.8-23.7,54.9-36.6c1.8-1.6,3.6-3.1,5.6-4.9L598,598l-8.3,33c-2.8,11-13.8,31-32.8,59.4c0.9,0.2,1.8,0.4,2.8,0.5c5.4,1,10.9,1.9,16.3,2.7c4.9,0.8,9.7,1.6,14.6,2.4c20.3-30.5,37.7-63.7,53.3-101.9c4-9.7,7.6-19.8,11.2-29.6c1.7-4.6,3.3-9.2,5-13.8l5.3-14.5l55.6,19.2l-5.4,16c-1.4,4.3-2.9,8.5-4.3,12.6c-20.3,56.4-44,104.4-72.6,146.6c-1.3,1.9-2.7,3.8-4.1,5.7c-1.3,1.7-2.6,3.5-3.8,5.3C624,751.7,614.3,756.8,601.8,756.8z M526.8,491.9c-3.5,5.2-7.1,10.5-11.3,15.5c-19.2,22.7-45.3,40-79.8,53.1c-34,12.9-68.6,19.6-102.8,20.1c-5.5,0.1-7.4,2.4-8.4,4.7c-1.2,2.7-1.8,5.8,2,10.4c42.4,51.6,95.8,89,163.3,114.4c35.5,13.4,72.4,21.9,109.5,25.5c0.9,0.1,1.8,0.1,2.7,0.1c5.3,0,8.4-1.6,11.2-5.8c1.4-2.1,2.9-4.1,4.4-6.1c1.2-1.6,2.4-3.2,3.5-4.9c27.5-40.7,50.5-87.1,70.2-141.9c1-2.7,1.9-5.5,2.9-8.3l-16-5.5c-1.1,2.9-2.1,5.8-3.1,8.6c-3.6,10-7.4,20.3-11.5,30.5c-16.5,40.3-34.8,75.3-56.2,107.1c-1.4,2.1-5.6,8.4-14.5,8.4c-1.1,0-2.3-0.1-3.6-0.3c-5.5-1-11-1.9-16.5-2.8c-5.6-0.9-11.1-1.8-16.7-2.8c-4.4-0.8-8.7-1.8-13.1-2.9c-1.9-0.5-3.8-0.9-5.7-1.4l-15.2-3.5l8.8-12.8c5.9-8.6,11-16.1,15.2-22.7c-8.9,5.9-18.5,11.4-28.9,15.9c-9.2,4-17,5.8-24.6,5.8l0,0c-8,0-15.8-2.2-23.1-6.4c-6.6-3.9-13.5-7.2-20.8-10.7c-3.3-1.6-6.6-3.2-9.9-4.8l-12.4-6.2l9.3-10.3c1-1.2,2-2.3,3-3.4c-4.4,1.4-9,2.7-13.8,3.8c-5.2,1.2-11.8-0.1-16-3.2c-9.1-6.7-18.5-13.9-28.6-22.1c-3.7-3-7-6.1-10.5-9.4c-1.5-1.4-3.1-2.9-4.7-4.4l-15.6-14.3l22.2-4.2c1-0.2,1.6-0.3,2.2-0.4c39.5-6.4,73-17.5,102.4-33.8c23-12.8,40.7-27.3,54.2-44.4c3.9-4.9,7.4-10.1,11.1-15.7L526.8,491.9z M724.9,544.7l-200.6-89.2l4.1-9.6c5.8-13.5,15.2-24.1,27.7-31.6c20.5-12.1,42.8-13.5,64.6-4c23.1,10.1,47.9,21,72.3,32.2c32.7,15.1,48.5,49.6,38.4,83.8c-0.5,1.8-1.2,3.5-1.9,5.4L724.9,544.7z M553,445l159.2,70.8c4.7-22.7-6.2-44-28.1-54.2c-24.2-11.2-48.8-22-71.9-32c-15.6-6.8-30.6-5.8-45.3,2.8C561.3,435.8,556.7,440,553,445z M358.4,529.1l-1.7,0c-32.1-1-57.6-27.5-56.9-59.3c0.6-30.9,27.1-57,57.8-57l1,0c15.3,0.3,30.3,6.9,41.1,18.2c10.8,11.2,16.5,25.8,16.1,40.9C415.2,503.4,389.4,529.1,358.4,529.1z M358.3,434c-20.1,0-36.9,16.6-37.3,36.2c-0.4,20.1,15.9,37,36.4,37.7l1,0c19.2,0,35.9-16.7,36.3-36.5c0.2-9.4-3.4-18.6-10.3-25.7C377.6,438.4,368,434.2,358.3,434L358.3,434z M696.8,438.9l-65.7-29.3c-2.2-1-3.5-2.4-4.1-3l-5.1-5.3l3.3-8.2c0.6-1.2,1.1-2.3,1.7-3.4l70.5-132.2c5.1-9.6,12.4-14.3,22.3-14.3c1.7,0,3.6,0.1,5.6,0.4c10.7,1.6,19.5,6.4,26,14.3c5.8,7,7.2,15.2,4.1,23.9c-12.8,35.1-25.5,70.2-38.2,105.4l-14.3,39.4c-0.3,0.8-0.7,1.6-1.3,2.7L696.8,438.9z M648.6,394.2l37.6,16.8l11.2-31.1c12.7-35.1,25.4-70.3,38.2-105.4c0.6-1.6,0.4-2-0.5-3.1c-3.2-3.9-7.3-6-12.8-6.8c-0.9-0.1-1.7-0.2-2.5-0.2c-1.5,0-2,0-3.6,3.1L648.6,394.2z M281.9,396.1c-21.1,0-39-17.9-39-39.1c0-21.5,17.5-39,39.1-39c10.6,0,20.4,4.2,27.8,11.6c7.3,7.4,11.3,17.3,11.2,27.7c-0.2,21.2-17.6,38.6-38.8,38.8H281.9z M282,339.2c-9.9,0-18,8-18,17.8c0,9.7,8.1,17.9,17.8,17.9v10.6l0.1-10.6c9.7-0.1,17.7-8,17.8-17.8c0-4.7-1.8-9.2-5.1-12.6C291.3,341.1,286.8,339.2,282,339.2z M367.4,396.1c-16.2,0-29.4-13.3-29.4-29.6c0-16.3,13.2-29.5,29.5-29.5c8.2,0.1,15.6,3.2,21.2,9c5.5,5.7,8.5,13.1,8.4,20.9c-0.3,15.9-13.4,29-29.4,29.2H367.4z M367.5,358.2c-4.7,0-8.3,3.6-8.3,8.3c0,4.6,3.8,8.4,8.3,8.4v10.6l0.1-10.6c4.4,0,8.3-3.9,8.4-8.4c0-2.1-0.8-4.2-2.4-5.8C371.9,359.1,369.7,358.2,367.5,358.2z"/></g>
        </svg>
      </button>
    </div>
    <div class="split">
      <label>
        Paste json data here:
        <input type="text" id="json" placeholder='[{"json": "here"}]'>
      </label>
      <label>
        Or upload .json file here:
        <input type="file" id="jsonFile" accept=".json">
      </label>
    </div>
    <div id="err">no errors</div>
    <div class="btns">
      <button id="import" title="import all the data">Import</button>
      <button id="update" title="update selected data">Update</button>
      <button id="cancel" title="close the plugin">&times;</button>
    </div>
  </div>
</div>

<script>
const errBlock = document.getElementById('err')
const jsonInput = document.getElementById('json')
const jsonFileInput = document.getElementById('jsonFile')
const imagesInput = document.getElementById('images')
const importBtn = document.getElementById('import')
const updateBtn = document.getElementById('update')
const clearCacheBtn = document.querySelector('.clearCache')

onmessage = async event => {
  const msg = event.data.pluginMessage
  
  if (msg.type == 'read-error') {
    showErr(`Image ${msg.name} not found.`)
  }
  else if (msg.type == 'read-success') {
    if (msg.function == 'import') {
      parent.postMessage({ pluginMessage: { type: 'import-data', data: msg.data } }, '*')
    } else if (msg.function == 'update') {
      parent.postMessage({ pluginMessage: { type: 'update-data', data: msg.data } }, '*')
    }
  }
  else if (msg.type == 'json-check-error') {
    showErr(msg.message)
  }
  else if (msg.type == 'json-check-success') {
    const images = imagesInput.files

    if (images.length) {
      showErr('Uploading images...')
      for (let i = 0; i < images.length; i++) {
        const image = await readImageAsBase64(images[i])
        parent.postMessage({ pluginMessage: { type: 'local-storage-write', name: images[i].name, image } }, '*')
      }
      showErr('Images successfully uploaded.')
    }
    
    parent.postMessage({ pluginMessage: { type: 'local-storage-read', data: msg.json, function: msg.function } }, '*')
      
  }
  else if (msg.type == 'no-selection') {
    showErr('Please select some elements to update.')
  }
  else if (msg.type == 'no-element') {
    showErr(`Can not find element in json named ${msg.name} .`)
  }
}

importBtn.onclick = async () => {
  await jsonCheck('import')
}

updateBtn.onclick = async () => {
  await jsonCheck('update')
}

async function jsonCheck(type) {
  try {
    const obj = await getJson()
    parent.postMessage({ pluginMessage: { type: 'json-check', json: obj, function: type } }, '*')
  }
  catch (e) {
    showErr(e)
  }
}

clearCacheBtn.onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'local-storage-clear' } }, '*')
  showErr('Cache cleared.')
  setTimeout(() => { hideErr() }, 2000)
}

jsonInput.oninput = () => {
  hideErr()
}

jsonFileInput.onchange = () => {
  hideErr()
}

imagesInput.oninput = () => {
  hideErr()
}

document.getElementById('cancel').onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*')
}

function showErr(text) {
    errBlock.innerHTML = text
    errBlock.style.opacity = 1
}

function hideErr() {
  errBlock.style.opacity = 0
}

async function readImageAsUint8Array(file) {
  const uint8data = await new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = function() {
      const arrayBuffer = reader.result
      const array = new Uint8Array(arrayBuffer)

      resolve(array)
    }
    reader.onerror = () => {
      throw `Can not read file ${file.name}. Please try again.`
    }
    reader.readAsArrayBuffer(file)
  })

  return uint8data
}

async function readImageAsBase64(file) {
  const base64 = await new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = function() {
      resolve(reader.result)
    }
    reader.onerror = () => {
      throw `Can not read file ${file.name}. Please try again.`
    }
    reader.readAsDataURL(file)
  })

  return base64
}

async function readJsonFile(file) {
  const json = await new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = function() {
      resolve(reader.result)
    }
    reader.onerror = () => {
      throw `Can not read file ${file.name}. Please try again.`
    }
    reader.readAsText(file)
  })

  return json
}

function getJson() {
  return new Promise(async (resolve, reject) => {
    const json = jsonInput.value.trim()
    const jsonFile = jsonFileInput.files[0]

    if (!json.length && !jsonFile) {
      reject("Please add json data.")
    } else {
      let obj
      if (json.length) {
        obj = JSON.parse(json)
      } else {
        obj = JSON.parse(await readJsonFile(jsonFile))
      }
      if (!obj.length) reject("JSON is empty.")

      resolve(obj)
    }
  })
}
</script>
